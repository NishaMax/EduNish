<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Profile - EduNish</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  const studentData = sessionStorage.getItem("edunishStudentData");
  if (!studentData) {
    // Always force login
    window.location.href = "studentLogin.html";
  } else {
    const student = JSON.parse(studentData);

    // ✅ Grade 10 page restriction
    if (window.location.pathname.includes("grade10.html") && student.access?.grade10 === false) {
      alert("❌ You do not have access to Grade 10 resources. Contact admin.");
      window.location.href = "index.html";
    }

    // ✅ Grade 11 page restriction
    if (window.location.pathname.includes("grade11.html") &&
        (student.grade === "10" || student.access?.grade11 === false)) {
      alert("❌ You do not have access to Grade 11 resources. Contact admin.");
      window.location.href = "index.html";
    }

    // ✅ Quiz restriction
    if (window.location.pathname.includes("quiz.html") && student.access?.quizzes === false) {
      alert("❌ You do not have access to quizzes. Contact admin.");
      window.location.href = "index.html";
    }
  }
</script>

</head>
<body class="bg-gray-100">

  <!-- Profile Section -->
  <div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">My Profile</h1>
    
    <div id="profile-details" class="space-y-4 text-gray-700">
      <p><strong>Student ID:</strong> <span id="student-id"></span></p>
      <p><strong>Full Name:</strong> <span id="student-name"></span></p>
      <p><strong>Email:</strong> <span id="student-email"></span></p>
      <p><strong>Grade:</strong> <span id="student-grade" class="font-semibold"></span></p>
    </div>

    <div id="access-section" class="mt-6 p-4 border rounded-lg bg-gray-50">
      <h2 class="text-xl font-semibold text-blue-700 mb-2">Page Access</h2>
      <ul class="list-disc list-inside text-gray-700 space-y-1">
        <li id="access-grade10"></li>
        <li id="access-grade11"></li>
        <li id="access-quizzes"></li>
        <li id="access-downloads"></li>
      </ul>
    </div>

    <div class="mt-8 flex justify-center space-x-4">
      <button id="logout-btn" class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition">Logout</button>
    </div>
  </div>

  <script type="module">
    // ✅ Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ✅ Firebase Config (YOUR API DETAILS)
    const firebaseConfig = {
      apiKey: "AIzaSyCeqwvVFwmOxIoSWI9qk64t9lnjwxYtrOs",
      authDomain: "edunish-211d0.firebaseapp.com",
      projectId: "edunish-211d0",
      storageBucket: "edunish-211d0.appspot.com",
      messagingSenderId: "1002400429038",
      appId: "1:1002400429038:web:12ee9a586de10e518694ff",
      measurementId: "G-7ZSDMMKFQ0"
    };

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ Get local student data
    // const studentData = localStorage.getItem("edunishStudentData");

    if (!studentData) {
      alert("⚠ Please log in first!");
      window.location.href = "studentLogin.html";
    }

    const student = JSON.parse(studentData);

    // ✅ Fetch latest student data from Firestore
    async function loadStudentProfile() {
      try {
        const docRef = doc(db, "students", student.studentId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          alert("⚠ Student data not found. Please contact admin.");
          localStorage.removeItem("edunishStudentData");
          window.location.href = "studentLogin.html";
          return;
        }

        const updatedData = docSnap.data();

        // ✅ Update localStorage with latest data
        localStorage.setItem("edunishStudentData", JSON.stringify(updatedData));

        // ✅ Display profile info
        document.getElementById("student-id").textContent = updatedData.studentId;
        document.getElementById("student-name").textContent = updatedData.fullName;
        document.getElementById("student-email").textContent = updatedData.email;
        document.getElementById("student-grade").textContent = updatedData.grade;

        // ✅ Check page access
        const access = updatedData.access || {
          grade10: updatedData.grade === "10" || updatedData.grade === "11",
          grade11: updatedData.grade === "11",
          quizzes: true,
          downloads: true
        };

        // ✅ Update access section
        document.getElementById("access-grade10").textContent =
          access.grade10 ? "✅ Grade 10 Resources: Allowed" : "❌ Grade 10 Resources: Blocked";
        document.getElementById("access-grade11").textContent =
          access.grade11 ? "✅ Grade 11 Resources: Allowed" : "❌ Grade 11 Resources: Blocked";
        document.getElementById("access-quizzes").textContent =
          access.quizzes ? "✅ Quizzes: Allowed" : "❌ Quizzes: Blocked";
        document.getElementById("access-downloads").textContent =
          access.downloads ? "✅ Downloads: Allowed" : "❌ Downloads: Blocked";
      } catch (err) {
        console.error("Error loading profile:", err);
        alert("⚠ Error loading profile. Try again later.");
      }
    }

    // ✅ Logout functionality
    document.getElementById("logout-btn").addEventListener("click", () => {
      localStorage.removeItem("edunishStudentData");
      window.location.href = "studentLogin.html";
    });

    // ✅ Load profile on page load
    loadStudentProfile();
  </script>
</body>
</html>
